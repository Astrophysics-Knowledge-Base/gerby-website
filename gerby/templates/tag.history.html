{% extends "layout.html" %}

{% block title %}History for tag {{ tag.tag }}{% endblock %}

{% block head %}
  <script type="text/javascript" src="/static/js/history.js"></script>
{% endblock %}

{% block breadcrumb %}

{% for parent in breadcrumb %}
  <li{% if loop.last %} class="active"{% endif %}>{{ parent.type | capitalize }} <a href="{{ tagURL(parent.tag) }}" data-tag="{{ parent.tag }}">{{ parent.ref }}</a>{% if parent.name %}: {{ parent.name }}{% endif %}
  {% if loop.last %}<span id="citation">(<a href="{{ tagURL(parent.tag) }}/cite">cite</a>)</span>{% endif %}
{% endfor %}

{% endblock %}

{% macro neighboursMacro(neighbours) %}

<ul class="neighbours">
{% if neighbours[0] %}
  <li class="left"><a href="{{ tagURL(neighbours[0].tag) }}/history">previous {{ neighbours[0].type }}</a>
{% endif %}
{% if neighbours[1] %}
  <li class="right"><a href="{{ tagURL(neighbours[1].tag) }}/history">next {{ neighbours[1].type }}</a>
{% endif %}
</ul>
{% if neighbours[0] or neighbours[1] %}<br style="clear:both">{% endif %}

{% endmacro %}

{% block hamburger %}
  {{ neighboursMacro(neighbours) }}
{% endblock %}

{% block body %}
<h2>Statement of tag <span class="tag">{{ tag.tag }}</span></h2>

<div class="html">
  {{ tag.html | safe }}
</div>
<p>

<h2>History of tag <span class="tag">{{ tag.tag }}</span></h2>

<table class="table table-hover table-sm" id="history">
  <thead>
    <tr>
      <th>type</th>
      <th>time</th>
      <th>link</th>
    </tr>
  </thead>

  <tbody>
{% for change in changes %}
<tr>
  <td>
    {% if change.action == "creation" %}
      {% set infix = "blob" %}
      {% set suffix = "#L" ~ change.begin ~ "-L" ~ change.end %}
      created statement with label <span class="label">{{ change.label }}</span> in <span class="filename">{{ change.filename }}.tex</span>

    {% elif change.action == "tag" %}
      {% set infix = "blob" %}
      assigned tag <span class="tag">{{ change.tag.tag }}</span> <!-- TODO maybe point to tags file? -->

    {% elif change.action == "statement" %}
      {% set infix = "commit" %}
      {% set suffix = "#diff-" ~ md5(change.filename ~ ".tex") ~ "R" ~ change.begin %}
      changed the statement

    {% elif change.action == "proof" %}
      {% set infix = "commit" %}
      {% set suffix = "#diff-" ~ md5(change.filename ~ ".tex") ~ "R" ~ change.begin %}
      changed the proof

    {% elif change.action == "statement and proof" %}
      {% set infix = "commit" %}
      {% set suffix = "#diff-" ~ md5(change.filename ~ ".tex") ~ "R" ~ change.begin %}
      changed the statement and the proof

    {% elif change.action == "move file" %}
      {% set infix = "blob" %}
      moved the statement to file <span class="filename">{{ change.filename }}.tex</span><!-- TODO use colours for filenames? -->

    {% elif change.action == "label" %}
      {% set infix = "commit" %}
      {% set suffix = "#diff-" ~ md5(change.filename ~ ".tex") ~ "R" ~ change.begin %}
      changed the label to <span class="label">{{ change.label }}</span>

    {% else %}
      <strong>if you see this, something went wrong</strong>
    {% endif %}
  </td>

  <td>{{ change.hash.time }}</td>
  <td><a href="https://github.com/stacks/stacks-project/{{ infix }}/{{ change.hash.hash }}/{{ change.filename }}.tex{{ suffix }}" class="commit">{{ change.hash.hash[0:7] }}</td> <!-- TODO build link -->
</tr>
<tr>
  <td colspan="3">
    <pre class="commit-message">{{ change.hash.log }}</pre>
  </td>
</tr>
{% endfor %}
  </tbody>
</table>

{% endblock %}

{% block sidebar %}
  <div id="interaction">
  {{ neighboursMacro(neighbours) }}
  </div>

  <hr>

  <div id="information">
    <ul id="tag-info">
      <li id="tag-history"><a href="/tag/{{ tag.tag }}/history">history</a>
      <li id="tag-statistics"><a href="/tag/{{ tag.tag }}/statistics">statistics</a>
      {% if dependencies | length > 0 %}
        <li id="tag-dependencies"><a href="/tag/{{ tag.tag }}/statistics#dependencies">{{ dependencies | length }} tag{% if dependencies | length > 1 %}s{% endif %} depend{% if dependencies | length == 1 %}s{% endif %} on this tag</a>
      {% endif %}
    </ul>
  </div>
{% endblock %}


