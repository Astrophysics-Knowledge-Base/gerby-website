{% set search = true %}

{% extends "layout.html" %}

{% block title %}Search{% endblock %}

{% block head %}
  <script type="text/javascript" src="/static/js/toggle.js"></script>

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/jquery-bonsai@2.1.3/jquery.bonsai.min.css">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery-bonsai@2.1.3/jquery.bonsai.min.js"></script>
{% endblock %}

{% block breadcrumb %}
  <li><a href="/search">Search</a>
{% endblock %}

{% macro searchlink(query, page, perpage, radius) %}
/search?query={{ query.replace(" ", "+") }}&page={{ page }}&perpage={{ perpage }}&radius={{ radius }}
{% endmacro %}

{% block sidebar %}
  <div class="interaction">
  </div>

  {% if count > 10 %}
    <nav id="results-per-page" class="pagination">
      <span class="page-item{% if perpage == 10 %} active{% endif %}"><a class="page-link" href="{{ searchlink(query, 1, 10, radius) }}">10</a></span>
      <span class="page-item{% if perpage == 50 %} active{% endif %}"><a class="page-link" href="{{ searchlink(query, 1, 50, radius) }}">50</a></span>
      <span class="page-item{% if perpage == 2**63-1 %} active{% endif %}"><a class="page-link" href="{{ searchlink(query, 1, "oo", radius) }}">&infin;</a></span>

      <p>results per page</span>
    </nav>
  {% endif %}

{% endblock %}

{% block hamburger %}
  <div class="interaction"></div>

  {% if count > 10 %}
    <nav id="results-per-page" class="pagination">
      <span class="page-item{% if perpage == 10 %} active{% endif %}"><a class="page-link" href="{{ searchlink(query, 1, 10, radius) }}">10</a></span>
      <span class="page-item{% if perpage == 50 %} active{% endif %}"><a class="page-link" href="{{ searchlink(query, 1, 50, radius) }}">50</a></span>
      <span class="page-item{% if perpage == 2**63-1 %} active{% endif %}"><a class="page-link" href="{{ searchlink(query, 1, "oo", radius) }}">&infin;</a></span>

      <p>results per page</span>
    </nav>
  {% endif %}
{% endblock %}

{% block pagination %}
  {% if count > perpage %}
    <nav>
      <ul id="pages" class="pagination flex-wrap">
      {% for i in range(1, ((count - 1) // perpage) + 2) %}
        <li class="page-item{% if i == page %} active{% endif %}"><a class="page-link" href="{{ searchlink(query, i, perpage, radius) }}">{{ i }}</a>
      {% endfor %}
      </ul>
    </nav>
  {% endif %}

{% endblock %}

{% block body %}
<form id="search" action="/search">
  <div class="form-group">
    <label for="query">Keywords</label>
    <input type="search" class="form-control" name="query" id="query" placeholder="keywords or a tag" autofocus value="{{ query | e }}">
  </div>

  <div class="form-group">
    <button type="submit" class="btn btn-primary">Search</button>

    <input type="radio" name="radius" id="allRadio" value="all"{% if radius == "all" %} checked{% endif %}>
    <label for="allRadio">Search all tags</label>
    <br>
    <input type="radio" name="radius" id="statementsRadio" value="statements"{% if not radius == "all" %} checked{% endif %}>
    <label for="statementsRadio">Search only statements</label>
  </div>

</form>

<hr>

{% if count == -1 %}
  <p>This query returned too many search results, please refine it.
{% else %}
  {{ self.pagination() }}

  <h2>{% if count == 0 %}No{% else %}{{ count }}{% endif %} result{% if count != 1 %}s{% endif %}
    {% if count > perpage %}
      (now showing results {{ perpage * (page - 1) + 1 }}&ndash;{{ [perpage * page, count] | sort | first }})
    {% endif %}
  </h2>

  {% if misspellt | length > 0 %}
  <p>The keyword{{ "(s)" if misspellt | length > 1 }} {% for keyword in misspellt %}<var>{{ keyword }}</var>{{ ", " if not loop.last }}{% endfor %} {% if misspellt | length == 1 %}is{% else %}are{% endif %} spellt differently in the Stacks project.
  <p>Do you perhaps want to search for <a href="{{ searchlink(alternative, page, perpage, radius) }}"><var>{{ alternative }}</var></a>?
  {% endif %}

  <ol id="search-results">
    {% if tree %}
      <ul class="tree">
      {% for item in tree recursive %}
        <li class="expanded">
        <span class="preview-title">{{ item.type | capitalize }} <a href="/tag/{{ item.tag }}" data-tag="{{ item.tag }}">{{ item.ref }}</a>{% if item.name %}: {{ item.name | safe }}{% endif %}{{ macros.badges(item) }}</span>

        {% if item.type not in headings %}
          <div class="html preview tex2jax_ignore">
            {{ item.html | safe }}
          </div>
        {% endif %}

        {% if item.children %}
          <ul>{{ loop(item.children) }}</ul>
        {% endif %}
      {% endfor %}
      </ul>

      <script type="text/javascript">
$("ul.tree").bonsai({
  addExpandAll: true,
});

// CSS doesn't have a parent selector so we mimick it in jQuery
$("ul.tree li div.preview").parent().prepend("<span class='previewable'></span>")

$("span.previewable").click(function(e) {
  $(e.target).siblings("div.preview").toggle();
  $(e.target).siblings("span.preview-title").toggle();
  $(e.target).toggleClass("previewing");

  // update MathJax
  $(e.target).siblings("div.preview").removeClass("tex2jax_ignore");
  MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
});

$(function () {
  $('[data-toggle="popover"]').popover()
})
      </script>
    {% endif %}
  </ol>

  {{ self.pagination() }}
{% endif %}
{% endblock %}

